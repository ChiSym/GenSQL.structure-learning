schema: '2.0'
stages:
  preprocess:
    cmd: "poetry run preprocess --data data/data.csv --output data/preprocessed.csv
      --sql \"SELECT * EXCLUDE (Body_Mass_Index) FROM data USING SAMPLE reservoir(20000
      ROWS) REPEATABLE (123);\"\n"
    deps:
    - path: data/data.csv
      hash: md5
      md5: ca067f6df1546ba4fe87f7bf9db8dfc0
      size: 7473589
    outs:
    - path: data/preprocessed.csv
      hash: md5
      md5: 9070e39ecac0ac0e9edd4e84c16c29ff
      size: 2652885
  create-column-models:
    cmd: "poetry run create-column-models --data data/preprocessed.csv --output data/column_models.json\n"
    deps:
    - path: data/preprocessed.csv
      hash: md5
      md5: 9070e39ecac0ac0e9edd4e84c16c29ff
      size: 2652885
    outs:
    - path: data/column_models.json
      hash: md5
      md5: c4103d741c20a88605cda10480a8092a
      size: 2940
  loom-schema:
    cmd: "poetry run loom_schema --column_models data/column_models.json --output
      data/loom-schema.json\n"
    deps:
    - path: data/column_models.json
      hash: md5
      md5: c4103d741c20a88605cda10480a8092a
      size: 2940
    outs:
    - path: data/loom-schema.json
      hash: md5
      md5: d82950e5d68c0a4eaf5eb858cdfdedd5
      size: 589
  loom-ingest:
    cmd: ./bin/loom_task ingest loom data/loom-schema.json data/preprocessed.csv
    deps:
    - path: data/loom-schema.json
      hash: md5
      md5: d82950e5d68c0a4eaf5eb858cdfdedd5
      size: 589
    - path: data/preprocessed.csv
      hash: md5
      md5: 9070e39ecac0ac0e9edd4e84c16c29ff
      size: 2652885
    outs:
    - path: loom/ingest
      hash: md5
      md5: 56e3fcb5739d7fd296fda2b35c822fc4.dir
      size: 1271516
      nfiles: 7
    - path: loom/query
      hash: md5
      md5: e0fb4e7f333c7efce3c7a9b7e7851141.dir
      size: 106
      nfiles: 1
  loom-infer-config:
    cmd: "yq -o=json '.loom' params.yaml > data/infer-config.json\n"
    outs:
    - path: data/infer-config.json
      hash: md5
      md5: 7f928ec52cc41312803872ea38fbf3d2
      size: 152
  loom-infer:
    cmd: ./bin/loom_task infer loom 10 data/infer-config.json
    deps:
    - path: data/infer-config.json
      hash: md5
      md5: 7f928ec52cc41312803872ea38fbf3d2
      size: 152
    - path: loom/ingest
      hash: md5
      md5: 56e3fcb5739d7fd296fda2b35c822fc4.dir
      size: 1271516
      nfiles: 7
    - path: loom/query
      hash: md5
      md5: e0fb4e7f333c7efce3c7a9b7e7851141.dir
      size: 106
      nfiles: 1
    params:
      params.yaml:
        sample_count: 10
    outs:
    - path: loom/samples
      hash: md5
      md5: 9c6fb2d8da078e46ecf3eced243d17ab.dir
      size: 18483507
      nfiles: 183
  loom-sample:
    cmd: "./bin/loom python scripts/loom_sample.py --sample_count 20000 --output data/synthetic-data-loom.csv\n"
    deps:
    - path: loom/samples
      hash: md5
      md5: 9c6fb2d8da078e46ecf3eced243d17ab.dir
      size: 18483507
      nfiles: 183
    - path: scripts/loom_sample.py
      hash: md5
      md5: d6449af8a6b43427f73f6ff14a87aec7
      size: 1290
    outs:
    - path: data/synthetic-data-loom.csv
      hash: md5
      md5: e2e5a812e01c9b6a784876df3d0f7a85
      size: 5674886
  loom-dump-metadata:
    cmd: "find loom/samples -type f ! -name '*.json' | parallel --verbose \"./bin/loom
      python scripts/loom_to_json.py loom_to_json {}\"\n"
    deps:
    - path: loom/samples
      hash: md5
      md5: eda41ef5ea950d8392cd4b1f2643f09f.dir
      size: 1162419
      nfiles: 42
    params:
      params.yaml:
        parallel.flags: --verbose
  loom_to_cgpm:
    cmd: "poetry run loom_to_cgpm --column_model_filename data/column_models.json
      --loom_filename loom/samples/sample.0/model.json\n"
    deps:
    - path: data/column_models.json
      hash: md5
      md5: 586ef82a47f37b4a71cbeee054acccac
      size: 3367
    - path: loom/samples
      hash: md5
      md5: eda41ef5ea950d8392cd4b1f2643f09f.dir
      size: 1162419
      nfiles: 42
  marginal-fits-loom:
    cmd: "mkdir -p qc/marginals && poetry run marginal_fits --real_data data/preprocessed.csv
      --model loom \n"
    deps:
    - path: data/preprocessed.csv
      hash: md5
      md5: 9070e39ecac0ac0e9edd4e84c16c29ff
      size: 2652885
    - path: data/synthetic-data-loom.csv
      hash: md5
      md5: e2e5a812e01c9b6a784876df3d0f7a85
      size: 5674886
    outs:
    - path: qc/marginals/loom_1d_fits.csv
      hash: md5
      md5: e0fb91e592427b27e6f58384f79ce032
      size: 1030
    - path: qc/marginals/loom_2d_fits.csv
      hash: md5
      md5: 728d060f8c19ca478923f938d1ceee02
      size: 23702
    - path: qc/marginals/loom_worst_1d_fit.html
      hash: md5
      md5: 699d5c76d476323060ddf06ec3d7bdbd
      size: 3642203
    - path: qc/marginals/loom_worst_1d_fit.png
      hash: md5
      md5: 30f589822aa5c847d2f9b2fdd7cfcc07
      size: 113140
    - path: qc/marginals/loom_worst_2d_fit.html
      hash: md5
      md5: bfdee9dbbe80b590cd5aad6f690a3cbb
      size: 4367009
    - path: qc/marginals/loom_worst_2d_fit.png
      hash: md5
      md5: bb293eb4a3d22307bde1c8f2bb830f02
      size: 161599
  loom-to-json:
    cmd: "find loom/samples -type f ! -name '*.json' | parallel  \"./bin/loom python
      scripts/loom_to_json.py loom_to_json {}\"\n"
    deps:
    - path: loom/samples
      hash: md5
      md5: e5e06d488ab5ec2ff462b38079c0ef87.dir
      size: 122879463
      nfiles: 253
  loom-to-cgpm:
    cmd: "mkdir -p data/cgpm/hydrated && ls loom/samples | parallel  \"poetry run
      loom_to_cgpm --column_model_filename data/column_models.json --data_filename
      data/preprocessed.csv --loom_folder loom/samples/{} --out_filename data/cgpm/hydrated/{}.json\"\
      \n"
    deps:
    - path: data/column_models.json
      hash: md5
      md5: c4103d741c20a88605cda10480a8092a
      size: 2940
    - path: data/preprocessed.csv
      hash: md5
      md5: 9070e39ecac0ac0e9edd4e84c16c29ff
      size: 2652885
    - path: loom/samples
      hash: md5
      md5: e5e06d488ab5ec2ff462b38079c0ef87.dir
      size: 122879463
      nfiles: 253
    outs:
    - path: data/cgpm/hydrated
      hash: md5
      md5: 011f0bdd892eecc7e85ff5fd207802ef.dir
      size: 50672916
      nfiles: 10
  cgpm-hydrated-sample:
    cmd: "poetry run cgpm-sample --sample_count 20000 --output data/synthetic-data-cgpm-raw.csv
      --model_dir data/cgpm/hydrated --data data/preprocessed.csv\n"
    deps:
    - path: data/cgpm/hydrated
      hash: md5
      md5: 011f0bdd892eecc7e85ff5fd207802ef.dir
      size: 50672916
      nfiles: 10
    outs:
    - path: data/synthetic-data-cgpm-raw.csv
      hash: md5
      md5: a23994e36385e62b26914c417274d651
      size: 7284446
  marginal-fits-cgpm-raw:
    cmd: "mkdir -p qc/marginals && poetry run marginal_fits --real_data data/preprocessed.csv
      --model cgpm-raw \n"
    deps:
    - path: data/preprocessed.csv
      hash: md5
      md5: 9070e39ecac0ac0e9edd4e84c16c29ff
      size: 2652885
    - path: data/synthetic-data-cgpm-raw.csv
      hash: md5
      md5: a23994e36385e62b26914c417274d651
      size: 7284446
    outs:
    - path: qc/marginals/cgpm-raw_1d_fits.csv
      hash: md5
      md5: f8f5b92fad5ab9f2015393e71a274547
      size: 1041
    - path: qc/marginals/cgpm-raw_2d_fits.csv
      hash: md5
      md5: d7d3137f9631e3b9108c3668972ecfd6
      size: 23153
    - path: qc/marginals/cgpm-raw_worst_1d_fit.html
      hash: md5
      md5: 695cb0b6493126dae32065d7342fbcb2
      size: 3642407
    - path: qc/marginals/cgpm-raw_worst_1d_fit.png
      hash: md5
      md5: 8efd22ae32d467f9020448bc961f56b6
      size: 115415
    - path: qc/marginals/cgpm-raw_worst_2d_fit.html
      hash: md5
      md5: 1d57847767c9352422911cfbf5e6934b
      size: 4546738
    - path: qc/marginals/cgpm-raw_worst_2d_fit.png
      hash: md5
      md5: 617d0f94dc842571847d0fc559ac31eb
      size: 173043
  data-cleaning:
    cmd: python pds_data_cleaning/scripts/merge_studies.py
    deps:
    - path: pds_data_cleaning/data
      hash: md5
      md5: 211d48d7feccd21005d258e6760d3cd2.dir
      size: 117199541
      nfiles: 53
    - path: pds_data_cleaning/processed_data
      hash: md5
      md5: f7e9ebaee7622286acc074fe0e3bc775.dir
      size: 162531689
      nfiles: 68
    outs:
    - path: data/data.csv
      hash: md5
      md5: ca067f6df1546ba4fe87f7bf9db8dfc0
      size: 7473589
