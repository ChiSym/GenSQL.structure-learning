schema: '2.0'
stages:
  subsample:
    cmd: "mkdir -p data/test && python scripts/subsample.py --data data/data.csv --test-data-dir
      data/test --params params.yaml --output data/subsampled.csv\n"
    deps:
    - path: data/data.csv
      hash: md5
      md5: f43a7238017f2ad295a5bfec56933248
      size: 8136977
    - path: scripts/subsample.py
      hash: md5
      md5: e984c015340dc2e50d926b4e3931b9dd
      size: 1821
    params:
      params.yaml:
        seed: 42
        sub_sample:
          according_to_columns:
            Org_size:
            - 10,000 or more employees
          N: 6000
    outs:
    - path: data/subsampled.csv
      hash: md5
      md5: 104756a17b05fcae61db02a7acfdba39
      size: 5810128
    - path: data/test
      hash: md5
      md5: d9a6553d279e92388f78ec7867329b0c.dir
      size: 2332391
      nfiles: 2
  validate-column-names:
    cmd: bin/validate.sh
    deps:
    - path: data/subsampled.csv
      hash: md5
      md5: 104756a17b05fcae61db02a7acfdba39
      size: 5810128
    outs:
    - path: data/validated.csv
      hash: md5
      md5: 104756a17b05fcae61db02a7acfdba39
      size: 5810128
  nullify:
    cmd: "clojure -X inferenceql.auto-modeling.main/nullify < data/validated.csv >
      data/nullified.csv\n"
    deps:
    - path: data/validated.csv
      hash: md5
      md5: 104756a17b05fcae61db02a7acfdba39
      size: 5810128
    params:
      params.yaml:
        nullify:
    outs:
    - path: data/nullified.csv
      hash: md5
      md5: 104756a17b05fcae61db02a7acfdba39
      size: 5810128
  guess-schema:
    cmd: "clojure -X inferenceql.auto-modeling.main/guess-schema < data/nullified.csv
      > data/schema.edn\n"
    deps:
    - path: data/nullified.csv
      hash: md5
      md5: 104756a17b05fcae61db02a7acfdba39
      size: 5810128
    params:
      params.yaml:
        schema:
          Salary_USD: numerical
          Work_experience: numerical
          Years_coding: numerical
          Years_coding_professionally: numerical
          Org_size: ignore
    outs:
    - path: data/schema.edn
      hash: md5
      md5: 1809ada97d5d44e44f62a975adbdcb2d
      size: 5527
  cgpm-schema:
    cmd: "clojure -X inferenceql.auto-modeling.main/cgpm-schema < data/schema.edn
      > data/cgpm-schema.edn\n"
    deps:
    - path: data/schema.edn
      hash: md5
      md5: 1809ada97d5d44e44f62a975adbdcb2d
      size: 5527
    outs:
    - path: data/cgpm-schema.edn
      hash: md5
      md5: def04f6cf1eaeda488575d8cb0c8c229
      size: 6618
  ignore:
    cmd: "clojure -X inferenceql.auto-modeling.main/ignore :schema '\"data/schema.edn\"\
      ' < data/nullified.csv > data/ignored.csv\n"
    deps:
    - path: data/nullified.csv
      hash: md5
      md5: 104756a17b05fcae61db02a7acfdba39
      size: 5810128
    - path: data/schema.edn
      hash: md5
      md5: 1809ada97d5d44e44f62a975adbdcb2d
      size: 5527
    outs:
    - path: data/ignored.csv
      hash: md5
      md5: 3c70752fa37400ff1c47fd32479b1ff6
      size: 5682141
  numericalize:
    cmd: "clojure -X inferenceql.auto-modeling.main/numericalize :schema '\"data/schema.edn\"\
      ' :table data/mapping-table.edn < data/ignored.csv > data/numericalized.csv\n"
    deps:
    - path: data/ignored.csv
      hash: md5
      md5: 3c70752fa37400ff1c47fd32479b1ff6
      size: 5682141
    - path: data/schema.edn
      hash: md5
      md5: 1809ada97d5d44e44f62a975adbdcb2d
      size: 5527
    outs:
    - path: data/mapping-table.edn
      hash: md5
      md5: 4c4d79065bc45fdfd25bad1987827129
      size: 10274
    - path: data/numericalized.csv
      hash: md5
      md5: 34d3a8cf4fd9a8b24cdec00afdb5b620
      size: 2790707
  loom-schema:
    cmd: "clojure -X inferenceql.auto-modeling.main/loom-schema < data/schema.edn
      > data/loom-schema.json\n"
    deps:
    - path: data/schema.edn
      hash: md5
      md5: 1809ada97d5d44e44f62a975adbdcb2d
      size: 5527
    outs:
    - path: data/loom-schema.json
      hash: md5
      md5: 56542d2ea7040f0c278ac7de0eaeb718
      size: 4367
  loom-ingest:
    cmd: ./bin/loom_task ingest loom data/loom-schema.json data/numericalized.csv
    deps:
    - path: data/loom-schema.json
      hash: md5
      md5: 56542d2ea7040f0c278ac7de0eaeb718
      size: 4367
    - path: data/numericalized.csv
      hash: md5
      md5: 34d3a8cf4fd9a8b24cdec00afdb5b620
      size: 2790707
    outs:
    - path: loom/ingest
      hash: md5
      md5: df2fe52c1a242eb95e7c680d55b64527.dir
      size: 789946
      nfiles: 7
    - path: loom/query
      hash: md5
      md5: d19072f5b984df40b09b007b6524cc09.dir
      size: 106
      nfiles: 1
  loom-infer-config:
    cmd: "clojure -X inferenceql.auto-modeling.main/infer-config < params.yaml > data/infer-config.json\n"
    params:
      params.yaml:
        loom.extra_passes: 100
        seed: 42
    outs:
    - path: data/infer-config.json
      hash: md5
      md5: 70b4dd42c4dfdfa83918a045e7078ab9
      size: 43
  loom-infer:
    cmd: ./bin/loom_task infer loom 60 data/infer-config.json
    deps:
    - path: data/infer-config.json
      hash: md5
      md5: 70b4dd42c4dfdfa83918a045e7078ab9
      size: 43
    - path: loom/ingest
      hash: md5
      md5: df2fe52c1a242eb95e7c680d55b64527.dir
      size: 789946
      nfiles: 7
    - path: loom/query
      hash: md5
      md5: d19072f5b984df40b09b007b6524cc09.dir
      size: 106
      nfiles: 1
    params:
      params.yaml:
        sample_count: 60
    outs:
    - path: loom/samples
      hash: md5
      md5: bbf1be19f2437c956f75d941754edde4.dir
      size: 45759546
      nfiles: 936
  loom-dump-metadata:
    cmd: "mkdir -p data/cgpm/raw && find loom/samples -mindepth 1 -maxdepth 1 -type
      d | parallel --verbose ./bin/loom python scripts/loom_dump.py {} --output data/cgpm/raw/{/}.json\n"
    deps:
    - path: loom/samples
      hash: md5
      md5: bbf1be19f2437c956f75d941754edde4.dir
      size: 45759546
      nfiles: 936
    - path: scripts/loom_dump.py
      hash: md5
      md5: c43616fe12258e9314fe1b481a6971e8
      size: 1978
    params:
      params.yaml:
        parallel.flags: --verbose
    outs:
    - path: data/cgpm/raw
      hash: md5
      md5: 1108a66d5435ed37ac05f8b0fd474084.dir
      size: 11020131
      nfiles: 60
  cgpm-hydrate-metadata:
    cmd: "find data/cgpm/raw -type f | parallel jsonschema --instance {} schemas/cgpm.json
      && mkdir -p data/cgpm/hydrated && rm -f data/cgpm/inf.log && find data/cgpm/raw
      -type f | sort | parallel --verbose 'python scripts/cgpm_hydrate.py --metadata
      {} --output data/cgpm/hydrated/{/} --data data/numericalized.csv --schema data/cgpm-schema.edn
      --mapping-table data/mapping-table.edn --seed $((42 + {#} - 1))'\n"
    deps:
    - path: data/cgpm-schema.edn
      hash: md5
      md5: def04f6cf1eaeda488575d8cb0c8c229
      size: 6618
    - path: data/cgpm/raw
      hash: md5
      md5: 1108a66d5435ed37ac05f8b0fd474084.dir
      size: 11020131
      nfiles: 60
    - path: data/mapping-table.edn
      hash: md5
      md5: 4c4d79065bc45fdfd25bad1987827129
      size: 10274
    - path: data/numericalized.csv
      hash: md5
      md5: 34d3a8cf4fd9a8b24cdec00afdb5b620
      size: 2790707
    - path: schemas/cgpm.json
      hash: md5
      md5: 75fb21013e98a73e03fbe1ace14426f2
      size: 4039
    - path: scripts/cgpm_hydrate.py
      hash: md5
      md5: 0ad32ff550f8b45a3642bddf279c9664
      size: 2971
    params:
      params.yaml:
        parallel.flags: --verbose
        seed: 42
    outs:
    - path: data/cgpm/hydrated
      hash: md5
      md5: 07f68a36e88eb5ff04ee616249b89158.dir
      size: 450492453
      nfiles: 60
  cgpm-infer-hyperparameters:
    cmd: "find data/cgpm/hydrated -type f | parallel jsonschema --instance {} schemas/cgpm.json
      && mkdir -p data/cgpm/complete && echo 2880 >> data/cgpm/inf.log && find data/cgpm/hydrated
      -type f | sort | parallel --verbose 'python scripts/cgpm_infer.py {} --kernel
      alpha --kernel view_alphas --kernel column_hypers --kernel rows --kernel columns
      --output data/cgpm/complete/{/} --data data/numericalized.csv --params params.yaml
      --seed $((42 + {#} - 1)) --minutes 2880'\n"
    deps:
    - path: data/cgpm/hydrated
      hash: md5
      md5: 07f68a36e88eb5ff04ee616249b89158.dir
      size: 450492453
      nfiles: 60
    - path: data/numericalized.csv
      hash: md5
      md5: 34d3a8cf4fd9a8b24cdec00afdb5b620
      size: 2790707
    - path: schemas/cgpm.json
      hash: md5
      md5: 75fb21013e98a73e03fbe1ace14426f2
      size: 4039
    - path: scripts/cgpm_infer.py
      hash: md5
      md5: 8c953870a8ac391bb77deeb105403131
      size: 4523
    params:
      params.yaml:
        cgpm:
          minutes: 2880
        parallel.flags: --verbose
        seed: 42
    outs:
    - path: data/cgpm/complete
      hash: md5
      md5: 15d4a0373f544033d04c96adfa1df574.dir
      size: 440087686
      nfiles: 60
  save-dependencies:
    cmd: "find data/cgpm/complete -type f | sort | xargs python scripts/dep_prob.py
      --data data/numericalized.csv --output data/dep-prob.json\n"
    deps:
    - path: data/cgpm/complete
      hash: md5
      md5: 15d4a0373f544033d04c96adfa1df574.dir
      size: 440087686
      nfiles: 60
    outs:
    - path: data/dep-prob.json
      hash: md5
      md5: f4c7405b2d3c2788ea198ceca1c77c7e
      size: 1420334
  save-max-number-views:
    cmd: "find data/cgpm/complete -type f | xargs python scripts/save_n_views.py >>
      data/max-number-views.txt\n"
    deps:
    - path: data/cgpm/complete
      hash: md5
      md5: 15d4a0373f544033d04c96adfa1df574.dir
      size: 440087686
      nfiles: 60
    outs:
    - path: data/max-number-views.txt
      hash: md5
      md5: aab3238922bcc25a6f606eb525ffdc56
      size: 2
  dep-prob-vl:
    cmd: "clojure -X inferenceql.auto-modeling.heatmap/vega-lite :stats-path '\"data/dep-prob.json\"\
      ' :domain '[0.0 1.0]' :default 1.0 :name '\"crosscat\"' :scheme '\"blues\"'
      > data/dep-prob.vl.json\n"
    deps:
    - path: data/dep-prob.json
      hash: md5
      md5: f4c7405b2d3c2788ea198ceca1c77c7e
      size: 1420334
    - path: src/clojure/inferenceql/auto_modeling/heatmap.clj
      hash: md5
      md5: f4f14b20f34f2f09c76dff87a7e908ee
      size: 7364
    outs:
    - path: data/dep-prob.vl.json
      hash: md5
      md5: 88f2ea6873e6ce8273daeb486e88691b
      size: 3461150
  dep-prob-vg:
    cmd: "pnpm vl2vg < data/dep-prob.vl.json > data/dep-prob.vg.json\n"
    deps:
    - path: data/dep-prob.vl.json
      hash: md5
      md5: 88f2ea6873e6ce8273daeb486e88691b
      size: 3461150
    outs:
    - path: data/dep-prob.vg.json
      hash: md5
      md5: 530a208cf6d8a02cb3ba1fc79aa73d12
      size: 3437673
  dep-prob-svg:
    cmd: "pnpm vg2svg < data/dep-prob.vg.json > data/dep-prob.svg\n"
    deps:
    - path: data/dep-prob.vg.json
      hash: md5
      md5: 530a208cf6d8a02cb3ba1fc79aa73d12
      size: 3437673
    outs:
    - path: data/dep-prob.svg
      hash: md5
      md5: de057db16d704b5b559eb12ba2453b14
      size: 9685678
  save-linear-stats:
    cmd: "python scripts/linear_stats.py --data data/ignored.csv --schema data/schema.edn
      --output data/linear-stats.json\n"
    deps:
    - path: data/ignored.csv
      hash: md5
      md5: 3c70752fa37400ff1c47fd32479b1ff6
      size: 5682141
    - path: data/schema.edn
      hash: md5
      md5: 1809ada97d5d44e44f62a975adbdcb2d
      size: 5527
    - path: scripts/linear_stats.py
      hash: md5
      md5: d5ebd4d1195a949b7c66ea7b77447f11
      size: 4361
    outs:
    - path: data/linear-stats.json
      hash: md5
      md5: 6a38bdc05ed095d37b8bdb586bd3e63b
      size: 4351289
  linear-stats-vl:
    cmd: "clojure -X inferenceql.auto-modeling.heatmap/vega-lite :stats-path '\"data/linear-stats.json\"\
      ' :sort-path '\"data/dep-prob.json\"' :domain '[1.0 0.0]' :default 0.0 :name
      '\"statistics\"' :field '\"p-value\"' :scheme '\"oranges\"' > data/linear-stats.vl.json\n"
    deps:
    - path: data/dep-prob.json
      hash: md5
      md5: f4c7405b2d3c2788ea198ceca1c77c7e
      size: 1420334
    - path: data/linear-stats.json
      hash: md5
      md5: 6a38bdc05ed095d37b8bdb586bd3e63b
      size: 4351289
    - path: src/clojure/inferenceql/auto_modeling/heatmap.clj
      hash: md5
      md5: f4f14b20f34f2f09c76dff87a7e908ee
      size: 7364
    outs:
    - path: data/linear-stats.vl.json
      hash: md5
      md5: 6e27556c942ead12b701ccb3f5673d63
      size: 3952496
  linear-stats-vg:
    cmd: "pnpm vl2vg < data/linear-stats.vl.json > data/linear-stats.vg.json\n"
    deps:
    - path: data/linear-stats.vl.json
      hash: md5
      md5: 6e27556c942ead12b701ccb3f5673d63
      size: 3952496
    outs:
    - path: data/linear-stats.vg.json
      hash: md5
      md5: 877fc6726a25b9c94bd8201179e33949
      size: 3969554
  linear-stats-svg:
    cmd: "pnpm vg2svg < data/linear-stats.vg.json > data/linear-stats.svg\n"
    deps:
    - path: data/linear-stats.vg.json
      hash: md5
      md5: 877fc6726a25b9c94bd8201179e33949
      size: 3969554
    outs:
    - path: data/linear-stats.svg
      hash: md5
      md5: 562b19b2da4520ceda1b131eaa87cf8a
      size: 10019458
  compare-dep-prob-with-linear:
    cmd: "python scripts/compare_deps.py --deps data/dep-prob.json --linear data/linear-stats.json
      >> data/qc-statistical-tests.txt\n"
    deps:
    - path: data/dep-prob.json
      hash: md5
      md5: f4c7405b2d3c2788ea198ceca1c77c7e
      size: 1420334
    - path: data/linear-stats.json
      hash: md5
      md5: 6a38bdc05ed095d37b8bdb586bd3e63b
      size: 4351289
    outs:
    - path: data/qc-statistical-tests.txt
      hash: md5
      md5: e45bca7f843fd59418c7f115dc0f30a8
      size: 390094
  ast-export:
    cmd:
    - 'parallel --verbose jsonschema --instance {} schemas/cgpm.json :::: <(find data/cgpm/complete
      -type f)'
    - mkdir -p data/ast
    - "parallel --verbose 'python scripts/ast_export.py --metadata {} --data data/numericalized.csv
      --mapping-table data/mapping-table.edn --output data/ast/{/.}.edn' :::: <(find
      data/cgpm/complete -type f)"
    deps:
    - path: data/cgpm/complete
      hash: md5
      md5: 15d4a0373f544033d04c96adfa1df574.dir
      size: 440087686
      nfiles: 60
    - path: data/ignored.csv
      hash: md5
      md5: 3c70752fa37400ff1c47fd32479b1ff6
      size: 5682141
    - path: scripts/ast_export.py
      hash: md5
      md5: 301e377deb0aaf75b1a961a6d91153a8
      size: 11045
    params:
      params.yaml:
        parallel.flags: --verbose
    outs:
    - path: data/ast
      hash: md5
      md5: 2a9b06852d09b22e41c667e0f886a9d2.dir
      size: 115081858
      nfiles: 60
