schema: '2.0'
stages:
  preprocess:
    cmd: "poetry run preprocess --data data/data.csv --output data/preprocessed.csv
      --column_model_output data/column_models.json --sql \"SELECT CASE rxarm WHEN
      'A' THEN 'Assigned endocrine therapy alone' WHEN 'B' THEN 'Randomized to endocrine
      therapy alone' WHEN 'C' THEN 'Randomized to chemo + endocrine therapy' WHEN
      'D' THEN 'Assigned chemo + endocrine therapy' ELSE NULL END as treatment_assignment,
      CASE ChemRegGp WHEN '1CMF' THEN 'CMF' WHEN '2Anthracycline w/o Taxane' THEN
      'Anthracycline' WHEN '3Anthracycline and Taxane' THEN 'Anthracycline and Taxane'
      WHEN '4TC and variations' THEN 'TC' WHEN '6None' THEN 'None' ELSE NULL END as
      chemotherapy, CASE WHEN TypeEndocrine IN ('AI', 'OFS & AI', 'Tam & AI') THEN
      'Yes' ELSE 'No' END as endocrine_therapy_ai, CASE WHEN TypeEndocrine IN ('OFS',
      'OFS & AI') THEN 'Yes' ELSE 'No' END as endocrine_therapy_ofs, CASE WHEN TypeEndocrine
      IN ('Tam', 'Tam & AI') THEN 'Yes' ELSE 'No' END as endocrine_therapy_tam, meno
      as menopausal_status, log(1 + RS) as genetic_recurrence_score, CASE age WHEN
      'NA' THEN NULL ELSE CAST (age AS FLOAT) END as age, CASE WHEN ethnicity = 1
      THEN 'Hispanic' WHEN race = 1 THEN 'White' WHEN race = 3 THEN 'Black' WHEN race
      = 4 THEN 'Asian' WHEN race = 5 THEN 'Native Hawaiian or Pacific Islander' WHEN
      race = 6 THEN 'Native American' WHEN race = 7 THEN 'Multirace' ELSE NULL END
      as race_ethnicity, log(CASE TumorSize WHEN 'NA' THEN NULL ELSE CAST (TumorSize
      AS FLOAT) END) as tumor_size, CASE Grade WHEN 'NA' THEN NULL ELSE Grade END
      as tumor_grade, CASE NucGrade WHEN 'NA' THEN NULL ELSE NucGrade END as nuclear_grade,
      CASE PRStatus WHEN 'NA' THEN NULL ELSE PRStatus END as progesterone_receptor_status,
      CASE PrimSurg WHEN 'Mx' THEN 'Mastectomy' WHEN 'Tx' THEN 'Breast conservation'
      ELSE NULL END as primary_surgical_procedure, log(1 + dfs) as disease_free_survival,
      CASE survstat WHEN 1 THEN 'dead' WHEN 0 THEN 'alive' ELSE NULL END as survival_status,
      CASE rfiind WHEN 1 THEN 'recurrence' WHEN 0 THEN 'no recurrence' ELSE NULL END
      as recurrence_indicator, CASE drfiind WHEN 1 THEN 'distant recurrence' WHEN
      0 THEN 'no distant recurrence' ELSE NULL END as distant_recurrence_indicator
      FROM data WHERE inel = 0\"\n"
    deps:
    - path: data/data.csv
      hash: md5
      md5: 934f3db330d8af2c7e0e5b136725b09b
      size: 1852524
    outs:
    - path: data/column_models.json
      hash: md5
      md5: d63357a222578d883286d7630fdcaf07
      size: 2531
    - path: data/preprocessed.csv
      hash: md5
      md5: 3925fc60051c23a623f684df372f9663
      size: 1989484
  create-column-models:
    cmd: "poetry run create-column-models --data data/preprocessed.csv --output data/column_models.json\n"
    deps:
    - path: data/preprocessed.csv
      hash: md5
      md5: b853bf59d00f3208387d92747ab15340
      size: 51991
    outs:
    - path: data/column_models.json
      hash: md5
      md5: e8b9c31c41b2cb967afc14be76e6b4d6
      size: 3350
  loom-schema:
    cmd: "poetry run loom_schema --column_models data/column_models.json --output
      data/loom-schema.json\n"
    deps:
    - path: data/column_models.json
      hash: md5
      md5: d63357a222578d883286d7630fdcaf07
      size: 2531
    outs:
    - path: data/loom-schema.json
      hash: md5
      md5: f0cc883d91a6a0e9100c94e157ab02c7
      size: 550
  loom-ingest:
    cmd: ./bin/loom_task ingest loom data/loom-schema.json data/preprocessed.csv
    deps:
    - path: data/loom-schema.json
      hash: md5
      md5: f0cc883d91a6a0e9100c94e157ab02c7
      size: 550
    - path: data/preprocessed.csv
      hash: md5
      md5: 3925fc60051c23a623f684df372f9663
      size: 1989484
    outs:
    - path: loom/ingest
      hash: md5
      md5: 00a3b2ba4a809f48af1ea790bffb1ab3.dir
      size: 418198
      nfiles: 7
    - path: loom/query
      hash: md5
      md5: 077ccbaffe78e4585bd316f1285a0a5c.dir
      size: 106
      nfiles: 1
  loom-infer-config:
    cmd: "yq -o=json '.loom' params.yaml > data/infer-config.json\n"
    outs:
    - path: data/infer-config.json
      hash: md5
      md5: 635e45f25f5910fb341da47f54770bdf
      size: 204
  loom-infer:
    cmd: ./bin/loom_task infer loom 10 data/infer-config.json
    deps:
    - path: data/infer-config.json
      hash: md5
      md5: 635e45f25f5910fb341da47f54770bdf
      size: 204
    - path: loom/ingest
      hash: md5
      md5: 00a3b2ba4a809f48af1ea790bffb1ab3.dir
      size: 418198
      nfiles: 7
    - path: loom/query
      hash: md5
      md5: 077ccbaffe78e4585bd316f1285a0a5c.dir
      size: 106
      nfiles: 1
    params:
      params.yaml:
        sample_count: 10
    outs:
    - path: loom/samples
      hash: md5
      md5: e6143357995d5dfa0dfd24c13f2eef1b.dir
      size: 57249648
      nfiles: 184
  loom-sample:
    cmd: "./bin/loom python scripts/loom_sample.py --sample_count 10000 --output data/synthetic-data-loom.csv\n"
    deps:
    - path: loom/samples
      hash: md5
      md5: e6143357995d5dfa0dfd24c13f2eef1b.dir
      size: 57249648
      nfiles: 184
    - path: scripts/loom_sample.py
      hash: md5
      md5: d6449af8a6b43427f73f6ff14a87aec7
      size: 1290
    outs:
    - path: data/synthetic-data-loom.csv
      hash: md5
      md5: 8af2dd438a073a3989331a83ff89d282
      size: 1906965
  loom-dump-metadata:
    cmd: "find loom/samples -type f ! -name '*.json' | parallel --verbose \"./bin/loom
      python scripts/loom_to_json.py loom_to_json {}\"\n"
    deps:
    - path: loom/samples
      hash: md5
      md5: eda41ef5ea950d8392cd4b1f2643f09f.dir
      size: 1162419
      nfiles: 42
    params:
      params.yaml:
        parallel.flags: --verbose
  loom_to_cgpm:
    cmd: "poetry run loom_to_cgpm --column_model_filename data/column_models.json
      --loom_filename loom/samples/sample.0/model.json\n"
    deps:
    - path: data/column_models.json
      hash: md5
      md5: 586ef82a47f37b4a71cbeee054acccac
      size: 3367
    - path: loom/samples
      hash: md5
      md5: eda41ef5ea950d8392cd4b1f2643f09f.dir
      size: 1162419
      nfiles: 42
  marginal-fits-loom:
    cmd: "mkdir -p qc/marginals && poetry run marginal_fits --real_data data/preprocessed.csv
      --model loom  --column_models data/column_models.json\n"
    deps:
    - path: data/preprocessed.csv
      hash: md5
      md5: 3925fc60051c23a623f684df372f9663
      size: 1989484
    - path: data/synthetic-data-loom.csv
      hash: md5
      md5: 8af2dd438a073a3989331a83ff89d282
      size: 1906965
    outs:
    - path: qc/marginals/loom_1d_fits.csv
      hash: md5
      md5: 51e0313a764f03559fc51598249a2d2f
      size: 938
    - path: qc/marginals/loom_2d_fits.csv
      hash: md5
      md5: 3d8b1bd212571067839b1cc6bf909202
      size: 12683
    - path: qc/marginals/loom_worst_1d_fit.html
      hash: md5
      md5: aad2a61812288507e12b4a482f59e097
      size: 3646318
    - path: qc/marginals/loom_worst_1d_fit.png
      hash: md5
      md5: be60964abaa4c32756eff60379c3f0ba
      size: 111057
    - path: qc/marginals/loom_worst_2d_fit.html
      hash: md5
      md5: f95c3efc555f163337ef104734c16db5
      size: 3932177
    - path: qc/marginals/loom_worst_2d_fit.png
      hash: md5
      md5: 0f7a5823b1ba45bb7d18ce81764fde30
      size: 74167
  loom-to-json:
    cmd: "find loom/samples -type f ! -name '*.json' | parallel  \"./bin/loom python
      scripts/loom_to_json.py loom_to_json {}\"\n"
    deps:
    - path: loom/samples
      hash: md5
      md5: e6143357995d5dfa0dfd24c13f2eef1b.dir
      size: 57249648
      nfiles: 184
  loom-to-cgpm:
    cmd: "mkdir -p data/cgpm/hydrated && ls loom/samples | parallel  \"poetry run
      loom_to_cgpm --column_model_filename data/column_models.json --data_filename
      data/preprocessed.csv --loom_folder loom/samples/{} --out_filename data/cgpm/hydrated/{}.json\"\
      \n"
    deps:
    - path: data/column_models.json
      hash: md5
      md5: d63357a222578d883286d7630fdcaf07
      size: 2531
    - path: data/preprocessed.csv
      hash: md5
      md5: 3925fc60051c23a623f684df372f9663
      size: 1989484
    - path: loom/samples
      hash: md5
      md5: e6143357995d5dfa0dfd24c13f2eef1b.dir
      size: 57249648
      nfiles: 184
    outs:
    - path: data/cgpm/hydrated
      hash: md5
      md5: 66ac088de57ef99086f016d4404ba7de.dir
      size: 11185489
      nfiles: 10
  cgpm-hydrated-sample:
    cmd: "poetry run cgpm-sample --sample_count 10000 --output data/synthetic-data-cgpm-raw.csv
      --model_dir data/cgpm/hydrated --data data/preprocessed.csv\n"
    deps:
    - path: data/cgpm/hydrated
      hash: md5
      md5: 66ac088de57ef99086f016d4404ba7de.dir
      size: 11185489
      nfiles: 10
    outs:
    - path: data/synthetic-data-cgpm-raw.csv
      hash: md5
      md5: df2210c18c98fc74093c77ab102752f8
      size: 2111766
  marginal-fits-cgpm-raw:
    cmd: "mkdir -p qc/marginals && poetry run marginal_fits --real_data data/preprocessed.csv
      --model cgpm-raw --column_models data/column_models.json\n"
    deps:
    - path: data/preprocessed.csv
      hash: md5
      md5: 3925fc60051c23a623f684df372f9663
      size: 1989484
    - path: data/synthetic-data-cgpm-raw.csv
      hash: md5
      md5: df2210c18c98fc74093c77ab102752f8
      size: 2111766
    outs:
    - path: qc/marginals/cgpm-raw_1d_fits.csv
      hash: md5
      md5: e9673048c9e37ae244b2019b4b29d928
      size: 938
    - path: qc/marginals/cgpm-raw_2d_fits.csv
      hash: md5
      md5: 7691e2fd4069db13cef477d2810f27a1
      size: 12666
    - path: qc/marginals/cgpm-raw_worst_1d_fit.html
      hash: md5
      md5: 87e2e54b3f7053abb9b3eed39847de0a
      size: 3646626
    - path: qc/marginals/cgpm-raw_worst_1d_fit.png
      hash: md5
      md5: 3d6e9904aa93c4a0c449f978ed5656e2
      size: 107812
    - path: qc/marginals/cgpm-raw_worst_2d_fit.html
      hash: md5
      md5: 5cb986ce22861cf01f7f426e1a184d76
      size: 3963136
    - path: qc/marginals/cgpm-raw_worst_2d_fit.png
      hash: md5
      md5: a6a5060e3a2fc3248142cb4c9de16511
      size: 82729
  dependence-probability:
    cmd: poetry run dependence-probability --model_dir data/cgpm/hydrated --out_file
      qc/cgpm-hydrated-dependence-probability.csv
    deps:
    - path: data/cgpm/hydrated
      hash: md5
      md5: 66ac088de57ef99086f016d4404ba7de.dir
      size: 11185489
      nfiles: 10
    outs:
    - path: qc/cgpm-hydrated-dependence-probability.csv
      hash: md5
      md5: ee59bfed87067e1bc8fd866fb4be4c7a
      size: 13646
  marginal-fits-cgpm-raw@0:
    cmd: "mkdir -p qc/marginals && poetry run marginal_fits --real_data data/preprocessed.csv
      --model \"cgpm-raw0\"  --column_models data/column_models.json\n"
    deps:
    - path: data/preprocessed.csv
      hash: md5
      md5: 3925fc60051c23a623f684df372f9663
      size: 1989484
    - path: data/synthetic-data-cgpm-raw0.csv
      hash: md5
      md5: 3b7e6e5ab69410c68dc5d13514bf41bc
      size: 2112827
  marginal-fits-cgpm-raw@1:
    cmd: "mkdir -p qc/marginals && poetry run marginal_fits --real_data data/preprocessed.csv
      --model \"cgpm-raw1\"  --column_models data/column_models.json\n"
    deps:
    - path: data/preprocessed.csv
      hash: md5
      md5: 3925fc60051c23a623f684df372f9663
      size: 1989484
    - path: data/synthetic-data-cgpm-raw0.csv
      hash: md5
      md5: 3b7e6e5ab69410c68dc5d13514bf41bc
      size: 2112827
  marginal-fits-cgpm-raw@2:
    cmd: "mkdir -p qc/marginals && poetry run marginal_fits --real_data data/preprocessed.csv
      --model \"cgpm-raw2\"  --column_models data/column_models.json\n"
    deps:
    - path: data/preprocessed.csv
      hash: md5
      md5: 3925fc60051c23a623f684df372f9663
      size: 1989484
    - path: data/synthetic-data-cgpm-raw0.csv
      hash: md5
      md5: 3b7e6e5ab69410c68dc5d13514bf41bc
      size: 2112827
  marginal-fits-cgpm-raw@3:
    cmd: "mkdir -p qc/marginals && poetry run marginal_fits --real_data data/preprocessed.csv
      --model \"cgpm-raw3\"  --column_models data/column_models.json\n"
    deps:
    - path: data/preprocessed.csv
      hash: md5
      md5: 3925fc60051c23a623f684df372f9663
      size: 1989484
    - path: data/synthetic-data-cgpm-raw0.csv
      hash: md5
      md5: 3b7e6e5ab69410c68dc5d13514bf41bc
      size: 2112827
  marginal-fits-cgpm-raw@4:
    cmd: "mkdir -p qc/marginals && poetry run marginal_fits --real_data data/preprocessed.csv
      --model \"cgpm-raw4\"  --column_models data/column_models.json\n"
    deps:
    - path: data/preprocessed.csv
      hash: md5
      md5: 3925fc60051c23a623f684df372f9663
      size: 1989484
    - path: data/synthetic-data-cgpm-raw0.csv
      hash: md5
      md5: 3b7e6e5ab69410c68dc5d13514bf41bc
      size: 2112827
  marginal-fits-cgpm-raw@5:
    cmd: "mkdir -p qc/marginals && poetry run marginal_fits --real_data data/preprocessed.csv
      --model \"cgpm-raw5\"  --column_models data/column_models.json\n"
    deps:
    - path: data/preprocessed.csv
      hash: md5
      md5: 3925fc60051c23a623f684df372f9663
      size: 1989484
    - path: data/synthetic-data-cgpm-raw0.csv
      hash: md5
      md5: 3b7e6e5ab69410c68dc5d13514bf41bc
      size: 2112827
  marginal-fits-cgpm-raw@6:
    cmd: "mkdir -p qc/marginals && poetry run marginal_fits --real_data data/preprocessed.csv
      --model \"cgpm-raw6\"  --column_models data/column_models.json\n"
    deps:
    - path: data/preprocessed.csv
      hash: md5
      md5: 3925fc60051c23a623f684df372f9663
      size: 1989484
    - path: data/synthetic-data-cgpm-raw0.csv
      hash: md5
      md5: 3b7e6e5ab69410c68dc5d13514bf41bc
      size: 2112827
  marginal-fits-cgpm-raw@7:
    cmd: "mkdir -p qc/marginals && poetry run marginal_fits --real_data data/preprocessed.csv
      --model \"cgpm-raw7\"  --column_models data/column_models.json\n"
    deps:
    - path: data/preprocessed.csv
      hash: md5
      md5: 3925fc60051c23a623f684df372f9663
      size: 1989484
    - path: data/synthetic-data-cgpm-raw0.csv
      hash: md5
      md5: 3b7e6e5ab69410c68dc5d13514bf41bc
      size: 2112827
  marginal-fits-cgpm-raw@8:
    cmd: "mkdir -p qc/marginals && poetry run marginal_fits --real_data data/preprocessed.csv
      --model \"cgpm-raw8\"  --column_models data/column_models.json\n"
    deps:
    - path: data/preprocessed.csv
      hash: md5
      md5: 3925fc60051c23a623f684df372f9663
      size: 1989484
    - path: data/synthetic-data-cgpm-raw0.csv
      hash: md5
      md5: 3b7e6e5ab69410c68dc5d13514bf41bc
      size: 2112827
  marginal-fits-cgpm-raw@9:
    cmd: "mkdir -p qc/marginals && poetry run marginal_fits --real_data data/preprocessed.csv
      --model \"cgpm-raw9\"  --column_models data/column_models.json\n"
    deps:
    - path: data/preprocessed.csv
      hash: md5
      md5: 3925fc60051c23a623f684df372f9663
      size: 1989484
    - path: data/synthetic-data-cgpm-raw0.csv
      hash: md5
      md5: 3b7e6e5ab69410c68dc5d13514bf41bc
      size: 2112827
  sample-baseline@ctgan:
    cmd: "poetry run sample-baseline --model ctgan --sample_count 10000\n"
    deps:
    - path: data/ctgan.pkl
      hash: md5
      md5: 69cc899c49fdf542b0c5bc6230c02376
      size: 9560607
    outs:
    - path: data/synthetic-data-ctgan.csv
      hash: md5
      md5: ee1ecb8877bafa8edb658cb542aa8339
      size: 1963027
  marginal-fits@ctgan:
    cmd: "poetry run marginal_fits --real_data data/preprocessed.csv --model ctgan
      --column_models data/column_models.json\n"
    deps:
    - path: data/preprocessed.csv
      hash: md5
      md5: 3925fc60051c23a623f684df372f9663
      size: 1989484
    - path: data/synthetic-data-ctgan.csv
      hash: md5
      md5: ee1ecb8877bafa8edb658cb542aa8339
      size: 1963027
    outs:
    - path: qc/marginals/ctgan_1d_fits.csv
      hash: md5
      md5: 572dbdee028694acf8ac4c2286926ca0
      size: 938
    - path: qc/marginals/ctgan_2d_fits.csv
      hash: md5
      md5: e6dd19e43af7c56e7bbf5dfcff3efd15
      size: 12684
    - path: qc/marginals/ctgan_worst_1d_fit.html
      hash: md5
      md5: ca46abbd64462fdf6e189c97d3e0f310
      size: 3646207
    - path: qc/marginals/ctgan_worst_1d_fit.png
      hash: md5
      md5: d3e44f3ffd680faa265c6135604c33db
      size: 103857
    - path: qc/marginals/ctgan_worst_2d_fit.html
      hash: md5
      md5: 8700da502aa5647669eeb688b1aba30b
      size: 4780385
    - path: qc/marginals/ctgan_worst_2d_fit.png
      hash: md5
      md5: 3ea63c3436ab2a39e7689d1d3b3ff0ff
      size: 122724
  marginal-fits-plot:
    cmd: "poetry run marginal-fits-plot -m cgpm-raw -m ctgan\n"
    deps:
    - path: qc/marginals/cgpm-raw_1d_fits.csv
      hash: md5
      md5: e9673048c9e37ae244b2019b4b29d928
      size: 938
    - path: qc/marginals/cgpm-raw_2d_fits.csv
      hash: md5
      md5: 7691e2fd4069db13cef477d2810f27a1
      size: 12666
    - path: qc/marginals/ctgan_1d_fits.csv
      hash: md5
      md5: 572dbdee028694acf8ac4c2286926ca0
      size: 938
    - path: qc/marginals/ctgan_2d_fits.csv
      hash: md5
      md5: e6dd19e43af7c56e7bbf5dfcff3efd15
      size: 12684
    outs:
    - path: qc/marginals/1d_fits.csv
      hash: md5
      md5: 0c07ffbd9fd2881909eee4121b63899f
      size: 1749
    - path: qc/marginals/2d_fits.csv
      hash: md5
      md5: 3c9f22c58af74095c677ca2517a55497
      size: 20731
  dependence-probability@hydrated:
    cmd: poetry run dependence-probability --model_dir data/cgpm/hydrated --out_file
      qc/cgpm-hydrated-dependence-probability.csv
    deps:
    - path: data/cgpm/hydrated
      hash: md5
      md5: 66ac088de57ef99086f016d4404ba7de.dir
      size: 11185489
      nfiles: 10
    outs:
    - path: qc/cgpm-hydrated-dependence-probability.csv
      hash: md5
      md5: ee59bfed87067e1bc8fd866fb4be4c7a
      size: 13646
  train-baseline@ctgan:
    cmd: "poetry run train-baseline --data data/preprocessed.csv --column_models data/column_models.json
      --model ctgan\n"
    deps:
    - path: data/column_models.json
      hash: md5
      md5: d63357a222578d883286d7630fdcaf07
      size: 2531
    - path: data/preprocessed.csv
      hash: md5
      md5: 3925fc60051c23a623f684df372f9663
      size: 1989484
    outs:
    - path: data/ctgan.pkl
      hash: md5
      md5: 69cc899c49fdf542b0c5bc6230c02376
      size: 9560607
