name: Smoke Test
on:
  schedule:
    - cron: 0 12 * * 1 # Every Monday at 8 AM EST (noon UTC)
  workflow_dispatch:
env:
  # DVC will use the shell defined by this variable or /bin/sh. We need DVC to use bash because
  # dvc-stream.yaml uses a bash feature -- process substitution.
  SHELL: /bin/bash
jobs:
  run-smoke-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Java
        uses: actions/setup-java@v1
        with:
          java-version: 11
      - name: Setup Clojure tools
        uses: DeLaGuardo/setup-clojure@master
        with:
          tools-deps: 1.10.1.727
      - name: Setup node
        uses: actions/setup-node@v1
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Install ws
        run: npm install ws
      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.4.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY_INFERENCEQL_MACHINE_USER }}
      - name: Cache m2
        uses: actions/cache@v2
        with:
          path: ~/.m2
          key: m2-${{ hashFiles('deps.edn') }}
      - name: Cache gitlibs
        uses: actions/cache@v2
        with:
          path: ~/.gitlibs
          key: gitlibs-${{ hashFiles('deps.edn') }}
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.9
      - name: Cache virtual environment
        uses: actions/cache@v2
        with:
          path: .venv
          key: venv-${{ env.pythonLocation }}-${{ hashFiles('Makefile', 'requirements.txt') }}
      - name: Install automodeling
        run: make install
      - name: Run complete smoke test
        run: bash test/smoke.sh
